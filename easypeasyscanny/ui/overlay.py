try:
    import webview
except ImportError:
    webview = None
import json
from ..infra.logger import get_logger
logger = get_logger(__name__)

INFO_HTML = "\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <style>\n        * {{\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }}\n\n        body {{\n            background: rgba(15, 15, 20, 0.95);\n            color: #ffffff;\n            font-family: 'Segoe UI', Arial, sans-serif;\n            font-size: 12px;\n            line-height: 1.2;\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            overflow: hidden;\n            backdrop-filter: blur(5px);\n        }}\n\n        .header {{\n            background: linear-gradient(90deg, rgba(30, 30, 40, 0.9), rgba(20, 20, 30, 0.9));\n            padding: 10px 15px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.15);\n            position: relative;\n        }}\n\n        .mineral-name {{\n            font-size: 18px;\n            font-weight: bold;\n            color: {tier_color};\n            margin-bottom: 3px;\n        }}\n\n        .signal-indicator {{\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }}\n\n        .signal-dot {{\n            width: 8px;\n            height: 8px;\n            background: #ffcc00;\n            border-radius: 50%;\n            box-shadow: 0 0 8px #ffcc00;\n        }}\n\n        .signal-value {{\n            color: #ffcc00;\n            font-weight: bold;\n            font-size: 16px;\n        }}\n\n        .stats-section {{\n            padding: 12px 15px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }}\n\n        .stats-table {{\n            width: 100%;\n            border-collapse: collapse;\n        }}\n\n        .stats-table th {{\n            text-align: right;\n            color: #cccccc;\n            font-weight: normal;\n            padding: 3px 8px 3px 0;\n            white-space: nowrap;\n        }}\n\n        .stats-table td {{\n            text-align: center;\n            color: #ffffff;\n            font-weight: bold;\n            padding: 3px 5px;\n            min-width: 45px;\n        }}\n\n        .stats-header {{\n            background: rgba(40, 40, 50, 0.7);\n            border-bottom: 1px solid rgba(255, 255, 255, 0.2);\n        }}\n\n        .stats-header td {{\n            color: #aaaaaa;\n            font-size: 10px;\n            padding: 5px 5px;\n        }}\n\n        .mineral-section {{\n            padding: 8px 15px 10px 15px;\n        }}\n\n        .mineral-header {{\n            color: #cccccc;\n            font-weight: bold;\n            margin-bottom: 8px;\n            font-size: 11px;\n        }}\n\n        .mineral-list {{\n            width: 100%;\n        }}\n\n        .mineral-table {{\n            width: 100%;\n            border-collapse: collapse;\n            border-spacing: 0;\n        }}\n\n        .mineral-table td {{\n            padding: 1px 0;\n            border: none;\n            vertical-align: middle;\n        }}\n\n        .mineral-bar-cell {{\n            padding-right: 8px;\n        }}\n\n        .mineral-bar {{\n            width: {mineral_bar_width}px;\n            height: 16px;\n            background: rgba(40, 40, 50, 0.8);\n            border-radius: 2px;\n            overflow: hidden;\n            position: relative;\n        }}\n\n        .mineral-fill {{\n            height: 100%;\n            transition: width 0.3s ease;\n            position: absolute;\n            left: 0;\n            top: 0;\n        }}\n\n        .mineral-name-in-bar {{\n            position: absolute;\n            left: 6px;\n            top: 50%;\n            transform: translateY(-50%);\n            font-size: 11px;\n            font-weight: bold;\n            white-space: nowrap;\n            z-index: 1;\n            color: #ffffff;\n            text-shadow: \n                -1px -1px 0 #000,\n                 1px -1px 0 #000,\n                -1px  1px 0 #000,\n                 1px  1px 0 #000,\n                -1px  0   0 #000,\n                 1px  0   0 #000,\n                 0   -1px 0 #000,\n                 0    1px 0 #000;\n        }}\n\n        .mineral-percentage-cell {{\n            width: 40px;\n            text-align: right;\n        }}\n\n        .mineral-percentage {{\n            color: #ffffff;\n            font-weight: bold;\n            font-size: 11px;\n        }}\n\n        .close-indicator {{\n            position: absolute;\n            top: 5px;\n            right: 8px;\n            color: #888;\n            font-size: 10px;\n        }}\n\n        .multima-indicator {{\n            background: rgba(255, 165, 0, 0.2);\n            border: 1px solid #ffa500;\n            border-radius: 4px;\n            padding: 2px 6px;\n            margin-top: 5px;\n            text-align: center;\n            color: #ffa500;\n            font-size: 10px;\n            font-weight: bold;\n        }}\n    </style>\n</head>\n<body>\n    <div class=\"close-indicator\">Auto-Hide {auto_hide_seconds}s</div>\n\n    <div class=\"header\">\n        <div class=\"mineral-name\">{rock['name']}</div>\n        <div class=\"signal-indicator\">\n            <div class=\"signal-dot\"></div>\n            <span class=\"signal-value\">{signal}</span>\n        </div>\n    </div>\n\n    <div class=\"stats-section\">\n        <table class=\"stats-table\">\n            <tr class=\"stats-header\">\n                <th></th>\n                <td>Min</td>\n                <td>Max</td>\n                <td>Med</td>\n            </tr>\n            <tr>\n    <th>Cluster Rocks</th>\n    <td>{cluster_min}</td>\n    <td>{cluster_max}</td>\n    <td>{cluster_med}</td>\n</tr>\n<tr>\n    <th>Rock Mass (t)</th>\n    <td>{rock_mass_min}</td>\n    <td>{rock_mass_max}</td>\n    <td>{rock_mass_med}</td>\n</tr>\n<tr>\n    <th>Instability</th>\n    <td>{instability_min}</td>\n    <td>{instability_max}</td>\n    <td>{instability_med}</td>\n</tr>\n<tr>\n    <th>Resistance</th>\n    <td>{resistance_min}</td>\n    <td>{resistance_max}</td>\n    <td>{resistance_med}</td>\n</tr>\n        </table>\n    </div>\n\n    <div class=\"mineral-section\">\n        <div class=\"mineral-header\">Mineral Composition</div>\n        <div class=\"mineral-list\">\n            <table class=\"mineral-table\">\n"
PRICE_HTML = "\n<!DOCTYPE html>\n<html>\n<head>\n    <meta charset=\"UTF-8\">\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: rgba(26, 26, 46, 0.95);\n            color: #00d4ff;\n            font-family: 'Segoe UI', Arial, sans-serif;\n            border: 2px solid rgba(0, 212, 255, 0.4);\n            border-radius: 10px;\n            padding: 12px 15px;\n            backdrop-filter: blur(5px);\n            overflow: hidden;\n        }\n\n        h2 {\n            text-align: center;\n            margin-bottom: 10px;\n            color: #00d4ff;\n            font-size: 1.2em;\n        }\n\n        .price-tables {\n            display: grid;\n            grid-template-columns: 1fr 1fr 1fr;\n            gap: 12px;\n        }\n\n        .price-table {\n            min-width: 0;\n        }\n\n        .price-table table {\n            width: 100%;\n            border-collapse: collapse;\n        }\n\n        .price-table th {\n            padding: 5px 3px;\n            text-align: left;\n            border-bottom: 2px solid rgba(0, 212, 255, 0.3);\n            color: #7fb3d3;\n            font-size: 0.7em;\n        }\n\n        .price-table th.tier-col {\n            width: 22px;\n            text-align: center;\n        }\n\n        .price-table th.price-col {\n            text-align: right;\n        }\n\n        .price-table td {\n            padding: 4px 3px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            font-size: 0.75em;\n        }\n\n        .tier-cell {\n            text-align: center;\n            font-weight: bold;\n            width: 22px;\n        }\n\n        .tier-s { color: #FFD700; }\n        .tier-1 { color: #FF6347; }\n        .tier-2 { color: #90EE90; }\n        .tier-3 { color: #87CEEB; }\n        .tier-4 { color: #DDA0DD; }\n        .tier-5 { color: #D3D3D3; }\n        .tier-6 { color: #A9A9A9; }\n\n        .resource-name {\n            font-weight: bold;\n            text-shadow: \n                -1px -1px 0 #000,\n                 1px -1px 0 #000,\n                -1px  1px 0 #000,\n                 1px  1px 0 #000;\n        }\n\n        .price {\n            text-align: right;\n            color: #b0b0b0;\n        }\n\n        .price-quantainium { color: #FFD700; }\n        .price-stileron { color: #9370DB; }\n        .price-bexalite { color: #90EE90; }\n        .price-borase { color: #90EE90; }\n        .price-taranite { color: #90EE90; }\n        .price-laranite { color: #90EE90; }\n        .price-agricium { color: #90EE90; }\n        .price-hephaestanite { color: #ffffff; }\n\n        .close-hint {\n            text-align: center;\n            margin-top: 8px;\n            color: #7fb3d3;\n            font-size: 0.65em;\n        }\n    </style>\n</head>\n<body>\n    <h2>Mineable Ore Prices</h2>\n    <div class=\"price-tables\">\n        <div class=\"price-table\">\n            <table>\n                <thead>\n                    <tr>\n                        <th class=\"tier-col\">T</th>\n                        <th>Resource</th>\n                        <th class=\"price-col\">Raw</th>\n                        <th class=\"price-col\">Ref</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class=\"tier-cell tier-s\">S</td>\n                        <td class=\"resource-name price-quantainium\">Quantainium</td>\n                        <td class=\"price\">44.00</td>\n                        <td class=\"price\">88.00</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-s\">S</td>\n                        <td class=\"resource-name price-stileron\">Stileron</td>\n                        <td class=\"price\">25.00</td>\n                        <td class=\"price\">50.00</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-s\">S</td>\n                        <td class=\"resource-name\">Ricote</td>\n                        <td class=\"price\">22.00</td>\n                        <td class=\"price\">44.00</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-1\">1</td>\n                        <td class=\"resource-name price-bexalite\">Bexalite</td>\n                        <td class=\"price\">20.33</td>\n                        <td class=\"price\">44.00</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-1\">1</td>\n                        <td class=\"resource-name price-taranite\">Taranite</td>\n                        <td class=\"price\">16.29</td>\n                        <td class=\"price\">35.21</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-1\">1</td>\n                        <td class=\"resource-name\">Gold</td>\n                        <td class=\"price\">3.20</td>\n                        <td class=\"price\">6.41</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-2\">2</td>\n                        <td class=\"resource-name price-borase\">Borase</td>\n                        <td class=\"price\">16.29</td>\n                        <td class=\"price\">35.21</td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n        <div class=\"price-table\">\n            <table>\n                <thead>\n                    <tr>\n                        <th class=\"tier-col\">T</th>\n                        <th>Resource</th>\n                        <th class=\"price-col\">Raw</th>\n                        <th class=\"price-col\">Ref</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class=\"tier-cell tier-2\">2</td>\n                        <td class=\"resource-name price-laranite\">Laranite</td>\n                        <td class=\"price\">15.51</td>\n                        <td class=\"price\">30.94</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-2\">2</td>\n                        <td class=\"resource-name price-agricium\">Agricium</td>\n                        <td class=\"price\">13.75</td>\n                        <td class=\"price\">27.50</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-2\">2</td>\n                        <td class=\"resource-name price-hephaestanite\">Hephaestanite</td>\n                        <td class=\"price\">7.38</td>\n                        <td class=\"price\">15.85</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-2\">2</td>\n                        <td class=\"resource-name\">Beryl</td>\n                        <td class=\"price\">2.21</td>\n                        <td class=\"price\">4.35</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-3\">3</td>\n                        <td class=\"resource-name\">Ice</td>\n                        <td class=\"price\">0.50</td>\n                        <td class=\"price\">1.00</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-3\">3</td>\n                        <td class=\"resource-name\">Titanium</td>\n                        <td class=\"price\">4.47</td>\n                        <td class=\"price\">8.78</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-3\">3</td>\n                        <td class=\"resource-name\">Tungsten</td>\n                        <td class=\"price\">2.05</td>\n                        <td class=\"price\">4.06</td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n        <div class=\"price-table\">\n            <table>\n                <thead>\n                    <tr>\n                        <th class=\"tier-col\">T</th>\n                        <th>Resource</th>\n                        <th class=\"price-col\">Raw</th>\n                        <th class=\"price-col\">Ref</th>\n                    </tr>\n                </thead>\n                <tbody>\n                    <tr>\n                        <td class=\"tier-cell tier-4\">4</td>\n                        <td class=\"resource-name\">Quartz</td>\n                        <td class=\"price\">0.78</td>\n                        <td class=\"price\">1.55</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-4\">4</td>\n                        <td class=\"resource-name\">Corundum</td>\n                        <td class=\"price\">1.35</td>\n                        <td class=\"price\">2.70</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-4\">4</td>\n                        <td class=\"resource-name\">Copper</td>\n                        <td class=\"price\">2.87</td>\n                        <td class=\"price\">6.16</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-4\">4</td>\n                        <td class=\"resource-name\">Tin</td>\n                        <td class=\"price\">0.55</td>\n                        <td class=\"price\">1.10</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-4\">4</td>\n                        <td class=\"resource-name\">Aluminum</td>\n                        <td class=\"price\">0.67</td>\n                        <td class=\"price\">1.30</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-4\">4</td>\n                        <td class=\"resource-name\">Silicon</td>\n                        <td class=\"price\">0.45</td>\n                        <td class=\"price\">0.90</td>\n                    </tr>\n                    <tr>\n                        <td class=\"tier-cell tier-5\">5</td>\n                        <td class=\"resource-name\">Diamond</td>\n                        <td class=\"price\">3.68</td>\n                        <td class=\"price\">7.35</td>\n                    </tr>\n                </tbody>\n            </table>\n        </div>\n    </div>\n    <div class=\"close-hint\">Numpad - zum Schlie\u00dfen | Verschiebbar mit Maus</div>\n</body>\n</html>\n"

class Overlays:
    def __init__(self):
        self._info_win = None
        self._price_win = None
    def show_info(self, payload: dict):
        if webview is None:
            logger.info("[Overlay] INFO: %s", payload); return
        html = INFO_HTML.replace("window.__DATA__", json.dumps(payload))
        if self._info_win is None:
            self._info_win = webview.create_window("Info", html=html, width=440, height=360, frameless=True, transparent=True, on_top=True)
            webview.start(private_mode=True, debug=False)
        else:
            self._info_win.load_html(html)
    def toggle_prices(self, prices=None):
        if webview is None:
            logger.info("[Overlay] PRICE TOGGLE"); return
        if self._price_win is None:
            html = PRICE_HTML.replace("window.__PRICES__", json.dumps(prices or []))
            self._price_win = webview.create_window("Prices", html=html, width=520, height=680, frameless=True, transparent=True, on_top=True)
            webview.start(private_mode=True, debug=False)
        else:
            try:
                self._price_win.destroy(); self._price_win=None
            except Exception:
                self._price_win=None
